<xml xmlns="https://developers.google.com/blockly/xml"><variables></variables><block type="pxt-on-start" id="n3C5Jzh!q*hq,sh+VT9+" x="20" y="20"><statement name="HANDLER"><block type="typescript_statement" id="4ix|,!iC%8OL3naqZzR("><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace MotorControl {" line1="    const PCA9685_ADDR = 0x40" line2="    const MODE1 = 0x00" line3="    const PRESCALE = 0xFE" line4="" line5="    // 电机通道映射 (M1~M4 正反转通道)" line6="    const MOTOR_CHANNELS = [" line7="        [12, 11], // M1: [正转, 反转]" line8="        [10, 9],  // M2" line9="        [8, 7],   // M3" line10="        [4, 3]    // M4" line11="    ]" line12="" line13="    let initialized = false" line14="" line15="    // ====== 核心电机控制函数 ======" line16="    /**" line17="     * 控制电机正反转与速度" line18="     * @param motor 电机编号 (1-4)" line19="     * @param speed 速度 (-255~255) " line20="     *   - 正值: 正转 (如 150)" line21="     *   - 负值: 反转 (如 -100)" line22="     */" line23="    //% blockId=mc_motor_run block=&quot;Motor %motor|speed %speed&quot;" line24="    //% speed.min=-255 speed.max=255" line25="    //% motor.min=1 motor.max=4" line26="    export function MotorRun(motor: number, speed: number): void {" line27="        if (!initialized) initPCA9685()" line28="        if (motor &lt; 1 || motor &gt; 4) return" line29="" line30="        const [a, b] = MOTOR_CHANNELS[motor - 1]" line31="        const pwm = Math.clamp(-4095, 4095, speed * 16)" line32="" line33="        if (pwm &gt;= 0) {" line34="            setPwm(a, 0, pwm)  // 正转通道" line35="            setPwm(b, 0, 0)    // 反转通道关闭" line36="        } else {" line37="            setPwm(a, 0, 0)    // 正转通道关闭" line38="            setPwm(b, 0, -pwm) // 反转通道" line39="        }" line40="    }" line41="" line42="    // ====== PCA9685 初始化 ======" line43="    function initPCA9685(): void {" line44="        i2cwrite(PCA9685_ADDR, MODE1, 0x00)" line45="        setFreq(50)" line46="        for (let ch = 0; ch &lt; 16; ch++) {" line47="            setPwm(ch, 0, 0)" line48="        }" line49="        initialized = true" line50="    }" line51="" line52="    function setFreq(freq: number): void {" line53="        const prescale = Math.floor(25000000 / 4096 / freq - 1)" line54="        const oldmode = i2cread(PCA9685_ADDR, MODE1)" line55="        const newmode = (oldmode &amp; 0x7F) | 0x10" line56="        i2cwrite(PCA9685_ADDR, MODE1, newmode)" line57="        i2cwrite(PCA9685_ADDR, PRESCALE, prescale)" line58="        i2cwrite(PCA9685_ADDR, MODE1, oldmode)" line59="        control.waitMicros(5000)" line60="        i2cwrite(PCA9685_ADDR, MODE1, oldmode | 0xA1)" line61="    }" line62="" line63="    // ====== PWM 通道设置 (内部使用) ======" line64="    function setPwm(channel: number, on: number, off: number): void {" line65="        if (channel &lt; 0 || channel &gt; 15) return" line66="        const buf = pins.createBuffer(5)" line67="        buf[0] = 0x06 + channel * 4" line68="        buf[1] = on &amp; 0xFF" line69="        buf[2] = (on &gt;&gt; 8) &amp; 0xFF" line70="        buf[3] = off &amp; 0xFF" line71="        buf[4] = (off &gt;&gt; 8) &amp; 0xFF" line72="        pins.i2cWriteBuffer(PCA9685_ADDR, buf)" line73="    }" line74="" line75="    // ====== I2C 辅助函数 ======" line76="    function i2cwrite(addr: number, reg: number, value: number): void {" line77="        const buf2 = pins.createBuffer(2)" line78="        buf2[0] = reg" line79="        buf2[1] = value" line80="        pins.i2cWriteBuffer(addr, buf2)" line81="    }" line82="" line83="    function i2cread(addr: number, reg: number): number {" line84="        pins.i2cWriteNumber(addr, reg, NumberFormat.UInt8BE)" line85="        return pins.i2cReadNumber(addr, NumberFormat.UInt8BE)" line86="    }" line87="}" numlines="88"></mutation></block></statement></block></xml>